import{_ as Ce,i as xe,o as v,c as B,e as o,a as t,w as l,b as Se,z as y,C as H,q as se,p as C,f as p,r,D as De,d,t as u,m as R,E as x,G as oe}from"./index-CYafs7gL.js";const ze={class:"user-manage"},Ie={class:"header-actions"},Re={class:"header-right"},Me={key:0,class:"password-cell"},Te={class:"password-text"},$e={key:1,class:"no-password"},Be={class:"pagination-container"},Le={class:"dialog-footer"},Pe={key:0,class:"user-detail"},Ee={class:"detail-section"},Qe={class:"detail-section"},Ne={class:"stat-card"},Ae={class:"stat-value"},Ke={class:"stat-card"},je={class:"stat-value"},Fe={class:"stat-card"},Ge={class:"stat-value"},Je={class:"stat-card"},Oe={class:"stat-value"},He={class:"stat-card"},We={class:"stat-value"},Xe={class:"stat-card"},Ye={class:"stat-value"},Ze={class:"stat-card"},qe={class:"stat-value"},et={class:"stat-card"},tt={class:"stat-value"},lt={class:"detail-section"},at={__name:"UserManage",setup(st){const W=p([]),X=p(0),z=p(1),M=p(20),L=p(!1),P=p(""),S=p(!1),n=p({id:"",username:"",studentId:"",phone:"",password:"",role:0,status:1}),E=p(!1),_=p(null),m=p({}),Q=p({collections:[],videos:[]}),T=p(!1),N=p("collections"),Y=se(()=>{const a=localStorage.getItem("userRole");return a?parseInt(a):0}),V=se(()=>Y.value===1),U=async()=>{L.value=!0;try{const a=await C.getUserList({keyword:P.value,page:z.value,size:M.value});a.code===0&&(W.value=a.data.list||[],X.value=a.data.total||0)}catch(a){console.error("加载用户列表失败:",a)}finally{L.value=!1}},A=()=>{z.value=1,U()},ne=a=>{M.value=a,U()},de=a=>{z.value=a,U()},ue=()=>{n.value={id:"",username:"",studentId:"",phone:"",password:"",role:0,status:1},S.value=!0},re=a=>{n.value={...a,password:""},S.value=!0},ie=async()=>{if(!n.value.username){x.warning("请填写用户名");return}try{let a;n.value.id?a=await C.updateUser(n.value.id,n.value):a=await C.createUser(n.value),a.code===0&&(x.success("保存成功"),S.value=!1,U())}catch(a){console.error("保存用户失败:",a)}},ce=async a=>{const e=a.status===1?0:1,i=e===1?"启用":"禁用";try{await oe.confirm(`确定要${i}该用户吗？`,"提示",{type:"warning"}),(await C.updateUser(a.id,{...a,status:e})).code===0&&(x.success(`${i}成功`),U())}catch(b){b!=="cancel"&&console.error("操作失败:",b)}},pe=async()=>{try{await oe.confirm(`确定要将用户 "${n.value.username}" 的密码重置为 "111111" 吗？`,"重置密码确认",{confirmButtonText:"确定重置",cancelButtonText:"取消",type:"warning"}),(await C.updateUser(n.value.id,{password:"111111"})).code===0&&(x.success("密码重置成功，新密码为：111111"),n.value.password="111111",U())}catch(a){a!=="cancel"&&(console.error("重置密码失败:",a),x.error("重置密码失败"))}},ve=async a=>{try{await navigator.clipboard.writeText(a),x.success("密码已复制到剪贴板")}catch{const i=document.createElement("textarea");i.value=a,document.body.appendChild(i),i.select(),document.execCommand("copy"),document.body.removeChild(i),x.success("密码已复制到剪贴板")}},_e=async a=>{_.value=a,E.value=!0,T.value=!0,N.value="collections";try{const e=await C.getUserStats(a.id);e.code===0&&(m.value=e.data||{});const i=await C.getUserRedeemedVideos(a.id);i.code===0&&(Q.value={collections:i.data.collections||[],videos:i.data.videos||[]})}catch(e){console.error("加载用户详情失败:",e)}finally{T.value=!1}},Z=a=>!a||a<200?Math.floor((a||0)/20)+1:10+Math.floor((a-200)/50),me=a=>{const e=String(a||"");return V.value?e:!e||e.length<=4?"****":e.substring(0,2)+"****"+e.substring(e.length-2)},q=a=>({0:"普通用户",1:"超级管理员",2:"管理员"})[a]||"普通用户",ee=a=>({0:"info",1:"danger",2:"warning"})[a]||"info",K=a=>a===1?"正常":"禁用",j=a=>a===1?"success":"danger",I=a=>a?new Date(a).toLocaleString():"-",fe=a=>{if(!a)return"0分钟";const e=Math.floor(a/3600),i=Math.floor(a%3600/60);return e>0?`${e}小时${i}分钟`:`${i}分钟`};return xe(()=>{if(!localStorage.getItem("userRole")){const a=localStorage.getItem("admin_token");if(a)try{const e=JSON.parse(atob(a.split(".")[1]));e.role!==void 0&&localStorage.setItem("userRole",e.role)}catch{console.log("无法从token解析role")}}console.log("当前用户角色:",Y.value),console.log("是否超级管理员:",V.value),console.log("localStorage userRole:",localStorage.getItem("userRole")),U()}),(a,e)=>{const i=r("Search"),b=r("el-icon"),f=r("el-button"),$=r("el-input"),D=r("el-tag"),ge=r("Plus"),c=r("el-table-column"),ye=r("CopyDocument"),F=r("el-table"),be=r("el-pagination"),k=r("el-form-item"),w=r("el-option"),G=r("el-select"),we=r("el-divider"),he=r("Refresh"),Ve=r("el-form"),te=r("el-dialog"),g=r("el-descriptions-item"),Ue=r("el-descriptions"),h=r("el-col"),le=r("el-row"),ae=r("el-tab-pane"),ke=r("el-tabs"),J=De("loading");return v(),B("div",ze,[o("div",Ie,[t($,{modelValue:P.value,"onUpdate:modelValue":e[0]||(e[0]=s=>P.value=s),placeholder:"搜索用户名或学号",class:"search-input",clearable:"",onClear:A,onKeyup:Se(A,["enter"])},{append:l(()=>[t(f,{onClick:A},{default:l(()=>[t(b,null,{default:l(()=>[t(i)]),_:1})]),_:1})]),_:1},8,["modelValue"]),o("div",Re,[V.value?(v(),y(D,{key:0,type:"danger",style:{"margin-right":"10px"}},{default:l(()=>[...e[13]||(e[13]=[d("超级管理员模式",-1)])]),_:1})):(v(),y(D,{key:1,type:"info",style:{"margin-right":"10px"}},{default:l(()=>[...e[14]||(e[14]=[d("普通管理员",-1)])]),_:1})),t(f,{type:"primary",onClick:ue},{default:l(()=>[t(b,null,{default:l(()=>[t(ge)]),_:1}),e[15]||(e[15]=d(" 添加用户 ",-1))]),_:1})])]),H((v(),y(F,{data:W.value,style:{width:"100%"},border:"",stripe:""},{default:l(()=>[t(c,{prop:"id",label:"ID",width:"60",align:"center"}),t(c,{prop:"username",label:"用户名","min-width":"100"}),t(c,{prop:"studentId",label:"学号",width:"120",align:"center"}),t(c,{label:"密码",width:"180",align:"center"},{default:l(({row:s})=>[s.password?(v(),B("div",Me,[o("span",Te,u(me(s.password)),1),V.value?(v(),y(f,{key:0,size:"small",type:"primary",link:"",class:"copy-btn",onClick:O=>ve(s.password),title:"复制密码"},{default:l(()=>[t(b,null,{default:l(()=>[t(ye)]),_:1})]),_:1},8,["onClick"])):R("",!0)])):(v(),B("span",$e,"未设置"))]),_:1}),t(c,{prop:"role",label:"角色",width:"100",align:"center"},{default:l(({row:s})=>[t(D,{type:ee(s.role)},{default:l(()=>[d(u(q(s.role)),1)]),_:2},1032,["type"])]),_:1}),t(c,{prop:"status",label:"状态",width:"80",align:"center"},{default:l(({row:s})=>[t(D,{type:j(s.status)},{default:l(()=>[d(u(K(s.status)),1)]),_:2},1032,["type"])]),_:1}),t(c,{prop:"registerDate",label:"注册时间",width:"150",align:"center"},{default:l(({row:s})=>[d(u(I(s.registerDate)),1)]),_:1}),t(c,{label:"操作",width:"220",align:"center",fixed:"right"},{default:l(({row:s})=>[t(f,{size:"small",type:"info",onClick:O=>_e(s)},{default:l(()=>[...e[16]||(e[16]=[d("详情",-1)])]),_:1},8,["onClick"]),t(f,{size:"small",onClick:O=>re(s)},{default:l(()=>[...e[17]||(e[17]=[d("编辑",-1)])]),_:1},8,["onClick"]),t(f,{size:"small",type:j(s.status)==="success"?"danger":"success",onClick:O=>ce(s)},{default:l(()=>[d(u(K(s.status)==="正常"?"禁用":"启用"),1)]),_:2},1032,["type","onClick"])]),_:1})]),_:1},8,["data"])),[[J,L.value]]),o("div",Be,[t(be,{"current-page":z.value,"onUpdate:currentPage":e[1]||(e[1]=s=>z.value=s),"page-size":M.value,"onUpdate:pageSize":e[2]||(e[2]=s=>M.value=s),"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",total:X.value,onSizeChange:ne,onCurrentChange:de},null,8,["current-page","page-size","total"])]),t(te,{modelValue:S.value,"onUpdate:modelValue":e[10]||(e[10]=s=>S.value=s),title:n.value.id?"编辑用户":"添加用户",width:"500px"},{footer:l(()=>[o("span",Le,[t(f,{onClick:e[9]||(e[9]=s=>S.value=!1)},{default:l(()=>[...e[20]||(e[20]=[d("取消",-1)])]),_:1}),t(f,{type:"primary",onClick:ie},{default:l(()=>[...e[21]||(e[21]=[d("确认",-1)])]),_:1})])]),default:l(()=>[t(Ve,{model:n.value,"label-width":"80px"},{default:l(()=>[t(k,{label:"用户名"},{default:l(()=>[t($,{modelValue:n.value.username,"onUpdate:modelValue":e[3]||(e[3]=s=>n.value.username=s),placeholder:"请输入用户名"},null,8,["modelValue"])]),_:1}),t(k,{label:"学号"},{default:l(()=>[t($,{modelValue:n.value.studentId,"onUpdate:modelValue":e[4]||(e[4]=s=>n.value.studentId=s),placeholder:"请输入学号"},null,8,["modelValue"])]),_:1}),t(k,{label:"密码"},{default:l(()=>[t($,{modelValue:n.value.password,"onUpdate:modelValue":e[5]||(e[5]=s=>n.value.password=s),placeholder:"请输入密码（留空则不修改）","show-password":""},null,8,["modelValue"])]),_:1}),t(k,{label:"角色"},{default:l(()=>[t(G,{modelValue:n.value.role,"onUpdate:modelValue":e[6]||(e[6]=s=>n.value.role=s),placeholder:"请选择角色",style:{width:"100%"}},{default:l(()=>[t(w,{label:"普通用户",value:0}),t(w,{label:"超级管理员",value:1}),t(w,{label:"管理员",value:2})]),_:1},8,["modelValue"])]),_:1}),t(k,{label:"状态"},{default:l(()=>[t(G,{modelValue:n.value.status,"onUpdate:modelValue":e[7]||(e[7]=s=>n.value.status=s),placeholder:"请选择状态",style:{width:"100%"}},{default:l(()=>[t(w,{label:"正常",value:1}),t(w,{label:"禁用",value:0})]),_:1},8,["modelValue"])]),_:1}),V.value&&n.value.id?(v(),y(we,{key:0,"content-position":"left"},{default:l(()=>[...e[18]||(e[18]=[d("超级管理员操作",-1)])]),_:1})):R("",!0),V.value&&n.value.id?(v(),y(k,{key:1,label:"修改权限"},{default:l(()=>[t(G,{modelValue:n.value.role,"onUpdate:modelValue":e[8]||(e[8]=s=>n.value.role=s),placeholder:"修改用户权限",style:{width:"100%"}},{default:l(()=>[t(w,{label:"普通用户",value:0}),t(w,{label:"超级管理员",value:1}),t(w,{label:"管理员",value:2})]),_:1},8,["modelValue"])]),_:1})):R("",!0),V.value&&n.value.id?(v(),y(k,{key:2},{default:l(()=>[t(f,{type:"danger",onClick:pe,style:{width:"100%"}},{default:l(()=>[t(b,null,{default:l(()=>[t(he)]),_:1}),e[19]||(e[19]=d(" 重置密码为 111111 ",-1))]),_:1})]),_:1})):R("",!0)]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),t(te,{modelValue:E.value,"onUpdate:modelValue":e[12]||(e[12]=s=>E.value=s),title:"用户详情",width:"800px",class:"user-detail-dialog"},{default:l(()=>[_.value?(v(),B("div",Pe,[o("div",Ee,[e[22]||(e[22]=o("h3",null,"基本信息",-1)),t(Ue,{column:3,border:""},{default:l(()=>[t(g,{label:"ID"},{default:l(()=>[d(u(_.value.id),1)]),_:1}),t(g,{label:"用户名"},{default:l(()=>[d(u(_.value.username),1)]),_:1}),t(g,{label:"学号"},{default:l(()=>[d(u(_.value.studentId||"-"),1)]),_:1}),t(g,{label:"角色"},{default:l(()=>[t(D,{type:ee(_.value.role)},{default:l(()=>[d(u(q(_.value.role)),1)]),_:1},8,["type"])]),_:1}),t(g,{label:"状态"},{default:l(()=>[t(D,{type:j(_.value.status)},{default:l(()=>[d(u(K(_.value.status)),1)]),_:1},8,["type"])]),_:1}),t(g,{label:"等级"},{default:l(()=>[d("Lv."+u(Z(m.value.totalQuestions)),1)]),_:1}),t(g,{label:"注册时间"},{default:l(()=>[d(u(I(_.value.registerDate)),1)]),_:1}),t(g,{label:"最后登录"},{default:l(()=>[d(u(I(_.value.lastLoginDate)),1)]),_:1}),t(g,{label:"积分"},{default:l(()=>[d(u(_.value.points||0),1)]),_:1})]),_:1})]),o("div",Qe,[e[31]||(e[31]=o("h3",null,"学习统计",-1)),t(le,{gutter:20},{default:l(()=>[t(h,{span:6},{default:l(()=>[o("div",Ne,[o("div",Ae,u(m.value.totalQuestions||0),1),e[23]||(e[23]=o("div",{class:"stat-label"},"总刷题数",-1))])]),_:1}),t(h,{span:6},{default:l(()=>[o("div",Ke,[o("div",je,u(m.value.todayQuestions||0),1),e[24]||(e[24]=o("div",{class:"stat-label"},"今日刷题",-1))])]),_:1}),t(h,{span:6},{default:l(()=>[o("div",Fe,[o("div",Ge,u(m.value.weekQuestions||0),1),e[25]||(e[25]=o("div",{class:"stat-label"},"本周刷题",-1))])]),_:1}),t(h,{span:6},{default:l(()=>[o("div",Je,[o("div",Oe,u(m.value.monthQuestions||0),1),e[26]||(e[26]=o("div",{class:"stat-label"},"本月刷题",-1))])]),_:1})]),_:1}),t(le,{gutter:20,style:{"margin-top":"15px"}},{default:l(()=>[t(h,{span:6},{default:l(()=>[o("div",He,[o("div",We,u(m.value.correctRate||0)+"%",1),e[27]||(e[27]=o("div",{class:"stat-label"},"正确率",-1))])]),_:1}),t(h,{span:6},{default:l(()=>[o("div",Xe,[o("div",Ye,u(m.value.studyDays||0),1),e[28]||(e[28]=o("div",{class:"stat-label"},"学习天数",-1))])]),_:1}),t(h,{span:6},{default:l(()=>[o("div",Ze,[o("div",qe,u(fe(m.value.totalDuration)),1),e[29]||(e[29]=o("div",{class:"stat-label"},"学习时长",-1))])]),_:1}),t(h,{span:6},{default:l(()=>[o("div",et,[o("div",tt,"Lv."+u(Z(m.value.totalQuestions)),1),e[30]||(e[30]=o("div",{class:"stat-label"},"当前等级",-1))])]),_:1})]),_:1})]),o("div",lt,[e[32]||(e[32]=o("h3",null,"兑换的视频",-1)),t(ke,{modelValue:N.value,"onUpdate:modelValue":e[11]||(e[11]=s=>N.value=s)},{default:l(()=>[t(ae,{label:"合集",name:"collections"},{default:l(()=>[H((v(),y(F,{data:Q.value.collections,size:"small"},{default:l(()=>[t(c,{prop:"name",label:"合集名称","min-width":"200"}),t(c,{prop:"video_count",label:"视频数",width:"80",align:"center"}),t(c,{prop:"access_time",label:"兑换时间",width:"150"},{default:l(({row:s})=>[d(u(I(s.access_time)),1)]),_:1})]),_:1},8,["data"])),[[J,T.value]])]),_:1}),t(ae,{label:"单个视频",name:"videos"},{default:l(()=>[H((v(),y(F,{data:Q.value.videos,size:"small"},{default:l(()=>[t(c,{prop:"title",label:"视频标题","min-width":"200"}),t(c,{prop:"subject_name",label:"科目",width:"100"}),t(c,{prop:"access_time",label:"兑换时间",width:"150"},{default:l(({row:s})=>[d(u(I(s.access_time)),1)]),_:1})]),_:1},8,["data"])),[[J,T.value]])]),_:1})]),_:1},8,["modelValue"])])])):R("",!0)]),_:1},8,["modelValue"])])}}},nt=Ce(at,[["__scopeId","data-v-f61b6ca1"]]);export{nt as default};
