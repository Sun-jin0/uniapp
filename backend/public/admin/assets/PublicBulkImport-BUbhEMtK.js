import{_ as Z,i as ee,p as te,o,c as C,e as u,a as i,w as a,t as I,F as x,y as A,z as f,m as D,f as F,r as _,q as T,k as L,a9 as se,d as c,T as ae,n as le,E as G,a1 as B}from"./index-CYafs7gL.js";const oe={class:"public-bulk-import-container"},ne={key:0,class:"preview-section"},re={class:"section-header"},ue={class:"book-list"},ie={class:"book-info"},ce={class:"book-detail"},de={class:"book-title"},pe={class:"book-meta"},fe={class:"file-tags"},me={class:"book-status"},ve={class:"footer-actions"},_e={__name:"PublicBulkImport",setup(ye){const M=F([]),S=F(0),d=F([]),z=F(!1),j=F(!1);ee(()=>{R()});const R=async()=>{try{const t=await te.getNavSubjects();t.code===0&&t.data&&t.data.length>0&&(M.value=t.data.map(e=>({id:e.subject_code||e.name,name:e.name})))}catch(t){console.error("加载科目失败:",t)}},W=t=>{S.value=t},J=t=>{const e=Array.from(t.target.files).filter(l=>l.name.endsWith(".json"));if(e.length===0){G.warning("没有找到 JSON 文件");return}H(e)},H=t=>{const e={};t.forEach(l=>{let n=l.name.replace(".json","");n=n.replace(/[\s\-_]?(questions|answers|structure|decrypted_output|结构)$/i,""),e[n]||(e[n]={name:n,files:[],selected:!0,status:"pending",errorMsg:"",preview:null}),e[n].files.push(l)}),d.value=Object.values(e).filter(l=>l.files.length>=3),z.value=!0,K()},N=t=>new Promise((e,l)=>{const n=new FileReader;n.onload=v=>{try{e(JSON.parse(v.target.result))}catch(m){l(m)}},n.onerror=l,n.readAsText(t)}),K=async()=>{for(let t=0;t<d.value.length;t++)await Q(t)},Q=async t=>{var l,n;const e=d.value[t];try{const v=e.files;let m,p,g,V;if(v.forEach(k=>{const b=k.name.toLowerCase();b.includes("questions")?p=k:b.includes("answers")?g=k:b.includes("structure")||b.includes("decrypted_output")||b.includes("结构")?V=k:m=k}),!m||!p||!g){e.status="error",e.errorMsg="缺少核心文件";return}const[h,r,q]=await Promise.all([N(m),N(p),N(g)]);let s=null;V&&(s=await N(V));const y=await B.previewImportPublicData({bookData:h.data||h,questions:((l=r.data)==null?void 0:l.question_list)||r.data||r,answers:q.data||q,chapterData:s,subject:M.value[S.value].id});y.code===0?(e.preview=y.data,e.status="previewed",e.parsedData={bookData:h.data||h,questions:((n=r.data)==null?void 0:n.question_list)||r.data||r,answers:q.data||q,chapterData:s}):(e.status="error",e.errorMsg=y.msg)}catch(v){e.status="error",e.errorMsg="解析失败",console.error(v)}},E=T({get:()=>{const t=d.value.filter(e=>e.status!=="processing"&&e.status!=="success");return t.length>0&&t.every(e=>e.selected)},set:t=>{P(t)}}),P=t=>{d.value.forEach(e=>{e.status!=="processing"&&e.status!=="success"&&(e.selected=t)})},$=T(()=>d.value.filter(t=>t.selected&&t.status!=="success").length),X=async()=>{if(j.value)return;j.value=!0;const t=d.value.filter(e=>e.selected&&e.status!=="success");for(const e of t){const l=d.value.indexOf(e);await O(l)}j.value=!1,G.success("批量导入完成")},Y=async t=>{await O(t)},O=async t=>{const e=d.value[t];e.status="processing";try{const{bookData:l,questions:n,answers:v,chapterData:m}=e.parsedData,p=await B.importPublicData({bookData:l,questions:n,answers:v,subject:M.value[S.value].id});if(p.code===0){const g=p.data.bookId;m&&await B.structureBook({bookId:g,chapterData:m}),e.status="success"}else e.status="error",e.errorMsg=p.msg}catch(l){e.status="error",e.errorMsg="导入异常",console.error(l)}};return(t,e)=>{const l=_("el-option"),n=_("el-select"),v=_("el-form-item"),m=_("el-icon"),p=_("el-button"),g=_("el-form"),V=_("el-card"),h=_("el-checkbox"),r=_("el-tag"),q=_("el-empty");return o(),C("div",oe,[e[13]||(e[13]=u("div",{class:"header"},[u("h2",null,"公共题库批量导入"),u("p",{class:"subtitle"},"选择文件夹或多个文件，自动识别并预览")],-1)),i(V,{class:"action-card"},{default:a(()=>[i(g,{inline:""},{default:a(()=>[i(v,{label:"选择科目"},{default:a(()=>[i(n,{modelValue:S.value,"onUpdate:modelValue":e[0]||(e[0]=s=>S.value=s),placeholder:"请选择科目",onChange:W},{default:a(()=>[(o(!0),C(x,null,A(M.value,(s,y)=>(o(),f(l,{key:s.id,label:s.name,value:y},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),i(v,null,{default:a(()=>[u("input",{type:"file",webkitdirectory:"",ref:"folderInput",style:{display:"none"},onChange:J},null,544),i(p,{type:"primary",onClick:e[1]||(e[1]=s=>t.$refs.folderInput.click())},{default:a(()=>[i(m,null,{default:a(()=>[i(L(se))]),_:1}),e[4]||(e[4]=c(" 选择文件夹 ",-1))]),_:1}),u("input",{type:"file",multiple:"",accept:".json",ref:"filesInput",style:{display:"none"},onChange:J},null,544),i(p,{onClick:e[2]||(e[2]=s=>t.$refs.filesInput.click())},{default:a(()=>[i(m,null,{default:a(()=>[i(L(ae))]),_:1}),e[5]||(e[5]=c(" 选择多个文件 ",-1))]),_:1})]),_:1})]),_:1})]),_:1}),d.value.length>0?(o(),C("div",ne,[u("div",re,[u("h3",null,"待导入书籍 ("+I(d.value.length)+")",1),i(h,{modelValue:E.value,"onUpdate:modelValue":e[3]||(e[3]=s=>E.value=s),onChange:P},{default:a(()=>[...e[6]||(e[6]=[c("全选",-1)])]),_:1},8,["modelValue"])]),u("div",ue,[(o(!0),C(x,null,A(d.value,(s,y)=>(o(),f(V,{key:y,class:le(["book-item",{imported:s.status==="success",error:s.status==="error",processing:s.status==="processing"}]),shadow:"hover"},{default:a(()=>{var k,b,U;return[u("div",ie,[i(h,{modelValue:s.selected,"onUpdate:modelValue":w=>s.selected=w,disabled:s.status==="processing"||s.status==="success"},null,8,["modelValue","onUpdate:modelValue","disabled"]),u("div",ce,[u("div",de,I(s.name),1),u("div",pe,[(k=s.preview)!=null&&k.questionCount?(o(),f(r,{key:0,size:"small"},{default:a(()=>[c(I(s.preview.questionCount)+" 题",1)]),_:2},1024)):D("",!0),(b=s.preview)!=null&&b.hasStructure?(o(),f(r,{key:1,size:"small",type:"warning"},{default:a(()=>[...e[7]||(e[7]=[c("含结构",-1)])]),_:1})):D("",!0),(o(!0),C(x,null,A((U=s.preview)==null?void 0:U.categories,w=>(o(),f(r,{size:"small",type:"info",key:w},{default:a(()=>[c(I(w),1)]),_:2},1024))),128))]),u("div",fe,[(o(!0),C(x,null,A(s.files,w=>(o(),C("span",{key:w.name,class:"file-tag"},I(w.name),1))),128))])])]),u("div",me,[s.status==="pending"?(o(),f(r,{key:0,type:"info"},{default:a(()=>[...e[8]||(e[8]=[c("等待预览",-1)])]),_:1})):s.status==="previewed"?(o(),f(r,{key:1,type:"success"},{default:a(()=>[...e[9]||(e[9]=[c("就绪",-1)])]),_:1})):s.status==="processing"?(o(),f(r,{key:2},{default:a(()=>[...e[10]||(e[10]=[c("导入中...",-1)])]),_:1})):s.status==="success"?(o(),f(r,{key:3,type:"success"},{default:a(()=>[...e[11]||(e[11]=[c("已完成",-1)])]),_:1})):s.status==="error"?(o(),f(r,{key:4,type:"danger"},{default:a(()=>[c(I(s.errorMsg||"失败"),1)]),_:2},1024)):D("",!0),s.status==="previewed"||s.status==="error"?(o(),f(p,{key:5,size:"small",type:"primary",onClick:w=>Y(y)},{default:a(()=>[...e[12]||(e[12]=[c(" 导入 ",-1)])]),_:1},8,["onClick"])):D("",!0)])]}),_:2},1032,["class"]))),128))]),u("div",ve,[i(p,{type:"primary",size:"large",loading:j.value,disabled:j.value||$.value===0,onClick:X},{default:a(()=>[c(" 开始批量导入 ("+I($.value)+") ",1)]),_:1},8,["loading","disabled"])])])):z.value?(o(),f(q,{key:1,description:"未识别到有效的 JSON 文件组合 (需包含 info, questions, answers)"})):D("",!0)])}}},be=Z(_e,[["__scopeId","data-v-fce99c58"]]);export{be as default};
