import{_ as Ge,i as Je,o as r,c as v,a as l,e as s,w as a,I as Pe,p as C,E as _,f as m,r as f,g as te,u as Ze,D as We,k as V,a8 as ye,d as c,m as x,F as N,y as I,n as fe,z as T,a5 as ge,Z as ke,a9 as Xe,t as M,M as we,T as Ye,aa as el,ab as ll,J as tl,b as al,O as nl,C as ol,G as Ce}from"./index-1rGkZLYp.js";import{d as sl}from"./vuedraggable.umd-BxriiCg7.js";const il={class:"tutorial-chapter-manage"},rl={class:"content mt-20"},ul={class:"card-header"},dl={class:"chapter-tree-container"},pl={key:0,class:"loading-container"},cl={key:1,class:"empty-container"},ml=["onClick"],vl={class:"chapter-name"},_l={class:"chapter-count"},yl={key:0,class:"section-list"},fl=["onClick"],gl={class:"section-name"},kl={class:"section-count"},wl={key:0,class:"question-list"},Cl={key:0,class:"question-loading"},Vl={key:1,class:"question-empty"},bl={key:2},xl={class:"question-toolbar"},hl={class:"question-item"},Ml={class:"question-index"},Ql={class:"question-type"},ql=["innerHTML"],Tl={class:"question-actions"},Sl={class:"select-question-container"},zl={class:"filter-bar mb-20"},Ul=["innerHTML"],Ol={class:"pagination-container mt-20"},$l={class:"option-label"},Dl={class:"option-actions"},Fl={key:0,class:"question-detail"},Hl={class:"question-info"},Ll=["innerHTML"],Al={key:0},Bl={key:1,class:"options-list"},El=["innerHTML"],Nl=["innerHTML"],Il={key:2},Kl=["innerHTML"],Rl={__name:"TutorialChapterManage",setup(jl){const Ve=Pe(),be=Ze(),S=Ve.params.id,K=m(null),R=m(!1),j=m([]),$=m([]),D=m([]),b=m({}),G=m({}),J=m({}),z=m(!1),P=m(!1),i=te({id:null,name:"",parentId:null,parentName:"",sortOrder:0,level:1}),A=m(!1),ae=m(null),ne=m(-1),F=m(null),g=te({keyword:"",type:"",page:1,pageSize:10}),oe=m([]),se=m(0),Z=m(!1),H=m(!1),U=m(null),W=m(!1),o=te({exercise_type_name:"单选题",stem:"",options:{A:"",B:"",C:"",D:""},answer:"",analysis:"",total_score:2}),X=m(!1),w=m(null),xe=async()=>{try{const t=await C.getTutorialDetail(S);K.value=t.data}catch(t){console.error("获取教辅详情失败:",t),_.error("获取教辅详情失败")}},Y=async()=>{R.value=!0;try{const t=await C.getTutorialChapters(S);j.value=t.data||[]}catch(t){console.error("获取章节列表失败:",t),_.error("获取章节列表失败")}finally{R.value=!1}},he=t=>{const e=$.value.indexOf(t);e>-1?$.value.splice(e,1):$.value.push(t)},Me=async t=>{const e=D.value.indexOf(t.id);e>-1?D.value.splice(e,1):(D.value.push(t.id),b.value[t.id]||await ee(t.id))},ee=async t=>{G.value[t]=!0;try{const e=await C.getChapterQuestions(t);b.value[t]=e.data||[]}catch(e){console.error("获取题目列表失败:",e),_.error("获取题目列表失败"),b.value[t]=[]}finally{G.value[t]=!1}},Qe=()=>{i.id=null,i.name="",i.parentId=null,i.parentName="",i.sortOrder=0,i.level=1,z.value=!0},qe=t=>{i.id=null,i.name="",i.parentId=t.id,i.parentName=t.name,i.sortOrder=0,i.level=2,z.value=!0},ie=t=>{i.id=t.id,i.name=t.name,i.parentId=t.parent_id,i.parentName=t.parent_name||"",i.sortOrder=t.sort_order||0,i.level=t.level||1,z.value=!0},Te=async()=>{if(!i.name.trim()){_.warning("请输入章节名称");return}P.value=!0;try{const t={name:i.name,sort_order:i.sortOrder,level:i.level,parent_id:i.parentId};i.id?(await C.updateTutorialChapter(i.id,t),_.success("更新成功")):(await C.createTutorialChapter(S,t),_.success("创建成功")),z.value=!1,Y()}catch(t){console.error("保存章节失败:",t),_.error("保存章节失败")}finally{P.value=!1}},re=async t=>{try{await Ce.confirm(t.level===1?"确定要删除该章节吗？将同时删除其下所有小节和题目关联。":"确定要删除该小节吗？将同时删除其下的题目关联。","警告",{type:"warning"}),await C.deleteTutorialChapter(t.id),_.success("删除成功"),Y()}catch(e){e!=="cancel"&&(console.error("删除章节失败:",e),_.error("删除章节失败"))}},ue=(t,e=!1,d=-1,y=null)=>{ae.value=t,ne.value=e?d:-1,F.value=y,g.keyword="",g.type="",g.page=1,B(),A.value=!0},B=async()=>{var t,e;Z.value=!0;try{const d=await C.getQuestions({keyword:g.keyword,type:g.type,page:g.page,pageSize:g.pageSize});oe.value=((t=d.data)==null?void 0:t.list)||[],se.value=((e=d.data)==null?void 0:e.total)||0}catch(d){console.error("搜索题目失败:",d),_.error("搜索题目失败")}finally{Z.value=!1}},Se=async t=>{var d;const e=ae.value;try{ne.value>-1&&F.value&&await C.removeTutorialQuestion(S,F.value),await C.addTutorialQuestion({tutorial_id:S,chapter_id:e.id,question_id:t.question_id,sort_order:((d=b.value[e.id])==null?void 0:d.length)||0}),await ee(e.id),e.question_count=(e.question_count||0)+(F.value?0:1),_.success(F.value?"替换成功":"添加成功"),A.value=!1}catch(y){console.error("选择题目失败:",y),_.error("选择题目失败")}},ze=(t,e,d)=>{ue(t,!0,d,e.question_id)},Ue=async(t,e,d)=>{try{await Ce.confirm("确定要删除该题目吗？","提示",{type:"warning"}),await C.removeTutorialQuestion(S,e.question_id),b.value[t.id].splice(d,1),t.question_count=Math.max(0,(t.question_count||0)-1),_.success("删除成功")}catch(y){y!=="cancel"&&(console.error("删除题目失败:",y),_.error("删除题目失败"))}},Oe=t=>{U.value=t,o.exercise_type_name="单选题",o.stem="",o.options={A:"",B:"",C:"",D:""},o.answer="",o.analysis="",o.total_score=2,H.value=!0},$e=()=>{const t=Object.keys(o.options),e=t[t.length-1],d=String.fromCharCode(e.charCodeAt(0)+1);o.options[d]=""},De=()=>{const t=Object.keys(o.options);if(t.length>2){const e=t[t.length-1];delete o.options[e]}else _.warning("至少需要保留两个选项")},Fe=async()=>{var t,e;if(!o.stem.trim()){_.warning("请输入题干");return}if(!o.answer.trim()){_.warning("请输入答案");return}W.value=!0;try{const d={exercise_type_name:o.exercise_type_name,stem:o.stem,answer:o.answer,analysis:o.analysis,total_score:o.total_score,options:["单选题","多选题","判断题"].includes(o.exercise_type_name)?o.options:null},p=(t=(await C.createQuestion(d)).data)==null?void 0:t.question_id;p&&U.value&&(await C.addTutorialQuestion({tutorial_id:S,chapter_id:U.value.id,question_id:p,sort_order:((e=b.value[U.value.id])==null?void 0:e.length)||0}),await ee(U.value.id),U.value.question_count=(U.value.question_count||0)+1,_.success("添加成功"),H.value=!1,o.stem="",o.answer="",o.analysis="",o.options={A:"",B:"",C:"",D:""})}catch(d){console.error("手动添加题目失败:",d),_.error("手动添加题目失败")}finally{W.value=!1}},He=t=>{w.value=t,X.value=!0},Le=t=>{J.value[t.id]=!0},Ae=async t=>{const e=b.value[t.id];if(!(!e||e.length===0))try{const d=e.map((y,p)=>({question_id:y.question_id,sort_order:p+1}));await C.updateTutorialQuestionOrder({chapter_id:t.id,questions:d}),_.success("顺序保存成功"),J.value[t.id]=!1}catch(d){console.error("保存顺序失败:",d),_.error("保存顺序失败")}},de=t=>t?t.replace(/<[^>]+>/g,""):"",Be=()=>{be.push("/computer/tutorials")};return Je(()=>{xe(),Y()}),(t,e)=>{var ve;const d=f("el-page-header"),y=f("el-icon"),p=f("el-button"),Ee=f("el-empty"),Ne=f("el-scrollbar"),Ie=f("el-card"),O=f("el-input"),Q=f("el-form-item"),pe=f("el-input-number"),ce=f("el-form"),E=f("el-dialog"),h=f("el-option"),me=f("el-select"),L=f("el-table-column"),Ke=f("el-table"),Re=f("el-pagination"),je=We("loading");return r(),v("div",il,[l(d,{onBack:Be,title:((ve=K.value)==null?void 0:ve.name)||"教辅章节管理"},null,8,["title"]),s("div",rl,[l(Ie,null,{header:a(()=>{var n;return[s("div",ul,[s("h3",null,M((n=K.value)==null?void 0:n.name)+" - 章节管理",1),l(p,{type:"primary",onClick:Qe},{default:a(()=>[l(y,null,{default:a(()=>[l(V(tl))]),_:1}),e[19]||(e[19]=c(" 添加章节 ",-1))]),_:1})])]}),default:a(()=>[s("div",dl,[R.value?(r(),v("div",pl,[l(y,{class:"is-loading"},{default:a(()=>[l(V(ye))]),_:1}),e[20]||(e[20]=c(" 加载中... ",-1))])):j.value.length===0?(r(),v("div",cl,[l(Ee,{description:"暂无章节"})])):x("",!0),(r(!0),v(N,null,I(j.value,n=>{var q;return r(),v("div",{key:n.id,class:"chapter-item"},[s("div",{class:fe(["chapter-header",{expanded:$.value.includes(n.id)}]),onClick:u=>he(n.id)},[l(y,{class:"expand-icon"},{default:a(()=>[$.value.includes(n.id)?(r(),T(V(ke),{key:1})):(r(),T(V(ge),{key:0}))]),_:2},1024),l(y,{class:"folder-icon"},{default:a(()=>[l(V(Xe))]),_:1}),s("span",vl,M(n.name),1),s("span",_l,"("+M(((q=n.children)==null?void 0:q.length)||0)+"节)",1),s("span",{class:"chapter-actions",onClick:e[0]||(e[0]=we(()=>{},["stop"]))},[l(p,{size:"small",type:"primary",link:"",onClick:u=>qe(n)},{default:a(()=>[...e[21]||(e[21]=[c(" 添加节 ",-1)])]),_:1},8,["onClick"]),l(p,{size:"small",type:"primary",link:"",onClick:u=>ie(n)},{default:a(()=>[...e[22]||(e[22]=[c(" 编辑 ",-1)])]),_:1},8,["onClick"]),l(p,{size:"small",type:"danger",link:"",onClick:u=>re(n)},{default:a(()=>[...e[23]||(e[23]=[c(" 删除 ",-1)])]),_:1},8,["onClick"])])],10,ml),$.value.includes(n.id)?(r(),v("div",yl,[(r(!0),v(N,null,I(n.children,u=>(r(),v("div",{key:u.id,class:"section-item"},[s("div",{class:fe(["section-header",{expanded:D.value.includes(u.id)}]),onClick:k=>Me(u)},[l(y,{class:"expand-icon"},{default:a(()=>[D.value.includes(u.id)?(r(),T(V(ke),{key:1})):(r(),T(V(ge),{key:0}))]),_:2},1024),l(y,{class:"document-icon"},{default:a(()=>[l(V(Ye))]),_:1}),s("span",gl,M(u.name),1),s("span",kl,"("+M(u.question_count||0)+"题)",1),s("span",{class:"section-actions",onClick:e[1]||(e[1]=we(()=>{},["stop"]))},[l(p,{size:"small",type:"primary",link:"",onClick:k=>ue(u)},{default:a(()=>[...e[24]||(e[24]=[c(" 选择题 ",-1)])]),_:1},8,["onClick"]),l(p,{size:"small",type:"success",link:"",onClick:k=>Oe(u)},{default:a(()=>[...e[25]||(e[25]=[c(" 手动录入 ",-1)])]),_:1},8,["onClick"]),l(p,{size:"small",type:"primary",link:"",onClick:k=>ie(u)},{default:a(()=>[...e[26]||(e[26]=[c(" 编辑 ",-1)])]),_:1},8,["onClick"]),l(p,{size:"small",type:"danger",link:"",onClick:k=>re(u)},{default:a(()=>[...e[27]||(e[27]=[c(" 删除 ",-1)])]),_:1},8,["onClick"])])],10,fl),D.value.includes(u.id)?(r(),v("div",wl,[G.value[u.id]?(r(),v("div",Cl,[l(y,{class:"is-loading"},{default:a(()=>[l(V(ye))]),_:1}),e[28]||(e[28]=c(" 加载中... ",-1))])):!b.value[u.id]||b.value[u.id].length===0?(r(),v("div",Vl," 暂无题目 ")):(r(),v("div",bl,[s("div",xl,[J.value[u.id]?(r(),T(p,{key:0,type:"success",size:"small",onClick:k=>Ae(u)},{default:a(()=>[l(y,null,{default:a(()=>[l(V(el))]),_:1}),e[29]||(e[29]=c(" 保存顺序 ",-1))]),_:1},8,["onClick"])):x("",!0)]),l(Ne,{"max-height":"400px"},{default:a(()=>[l(V(sl),{modelValue:b.value[u.id],"onUpdate:modelValue":k=>b.value[u.id]=k,"item-key":"question_id",handle:".drag-handle",onEnd:k=>Le(u),class:"question-drag-list"},{item:a(({element:k,index:le})=>[s("div",hl,[l(y,{class:"drag-handle"},{default:a(()=>[l(V(ll))]),_:1}),s("span",Ml,M(le+1)+".",1),s("span",Ql,"["+M(k.exercise_type_name)+"]",1),s("span",{class:"question-stem",innerHTML:de(k.stem)},null,8,ql),s("span",Tl,[l(p,{size:"small",type:"primary",link:"",onClick:_e=>He(k)},{default:a(()=>[...e[30]||(e[30]=[c(" 查看 ",-1)])]),_:1},8,["onClick"]),l(p,{size:"small",type:"warning",link:"",onClick:_e=>ze(u,k,le)},{default:a(()=>[...e[31]||(e[31]=[c(" 重选 ",-1)])]),_:1},8,["onClick"]),l(p,{size:"small",type:"danger",link:"",onClick:_e=>Ue(u,k,le)},{default:a(()=>[...e[32]||(e[32]=[c(" 删除 ",-1)])]),_:1},8,["onClick"])])])]),_:2},1032,["modelValue","onUpdate:modelValue","onEnd"])]),_:2},1024)]))])):x("",!0)]))),128))])):x("",!0)])}),128))])]),_:1})]),l(E,{modelValue:z.value,"onUpdate:modelValue":e[5]||(e[5]=n=>z.value=n),title:i.id?"编辑章节":"添加章节",width:"500px"},{footer:a(()=>[l(p,{onClick:e[4]||(e[4]=n=>z.value=!1)},{default:a(()=>[...e[33]||(e[33]=[c("取消",-1)])]),_:1}),l(p,{type:"primary",onClick:Te,loading:P.value},{default:a(()=>[...e[34]||(e[34]=[c("保存",-1)])]),_:1},8,["loading"])]),default:a(()=>[l(ce,{model:i,"label-width":"100px"},{default:a(()=>[l(Q,{label:"章节名称",required:""},{default:a(()=>[l(O,{modelValue:i.name,"onUpdate:modelValue":e[2]||(e[2]=n=>i.name=n),placeholder:"请输入章节名称"},null,8,["modelValue"])]),_:1}),i.parentId?(r(),T(Q,{key:0,label:"父章节"},{default:a(()=>[l(O,{value:i.parentName,disabled:""},null,8,["value"])]),_:1})):x("",!0),l(Q,{label:"排序"},{default:a(()=>[l(pe,{modelValue:i.sortOrder,"onUpdate:modelValue":e[3]||(e[3]=n=>i.sortOrder=n),min:0,style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),l(E,{modelValue:A.value,"onUpdate:modelValue":e[10]||(e[10]=n=>A.value=n),title:"选择题目",width:"900px"},{default:a(()=>[s("div",Sl,[s("div",zl,[l(O,{modelValue:g.keyword,"onUpdate:modelValue":e[6]||(e[6]=n=>g.keyword=n),placeholder:"搜索题目...",clearable:"",style:{width:"300px"},onKeyup:al(B,["enter"])},{append:a(()=>[l(p,{onClick:B},{default:a(()=>[l(y,null,{default:a(()=>[l(V(nl))]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(me,{modelValue:g.type,"onUpdate:modelValue":e[7]||(e[7]=n=>g.type=n),placeholder:"题型",clearable:"",style:{width:"150px","margin-left":"10px"}},{default:a(()=>[l(h,{label:"单选题",value:"单选题"}),l(h,{label:"多选题",value:"多选题"}),l(h,{label:"填空题",value:"填空题"}),l(h,{label:"解答题",value:"解答题"}),l(h,{label:"判断题",value:"判断题"})]),_:1},8,["modelValue"])]),ol((r(),T(Ke,{data:oe.value,border:"",stripe:"",height:"400"},{default:a(()=>[l(L,{type:"index",label:"序号",width:"60",align:"center"}),l(L,{prop:"question_id",label:"题目ID",width:"150","show-overflow-tooltip":""}),l(L,{prop:"exercise_type_name",label:"题型",width:"100",align:"center"}),l(L,{prop:"stem",label:"题干","min-width":"300","show-overflow-tooltip":""},{default:a(({row:n})=>[s("div",{innerHTML:de(n.stem)},null,8,Ul)]),_:1}),l(L,{label:"操作",width:"100",align:"center",fixed:"right"},{default:a(({row:n})=>[l(p,{type:"primary",size:"small",onClick:q=>Se(n)},{default:a(()=>[...e[35]||(e[35]=[c("选择",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[je,Z.value]]),s("div",Ol,[l(Re,{"current-page":g.page,"onUpdate:currentPage":e[8]||(e[8]=n=>g.page=n),"page-size":g.pageSize,"onUpdate:pageSize":e[9]||(e[9]=n=>g.pageSize=n),total:se.value,layout:"total, prev, pager, next",onCurrentChange:B},null,8,["current-page","page-size","total"])])])]),_:1},8,["modelValue"]),l(E,{modelValue:H.value,"onUpdate:modelValue":e[17]||(e[17]=n=>H.value=n),title:"手动录入题目",width:"800px"},{footer:a(()=>[l(p,{onClick:e[16]||(e[16]=n=>H.value=!1)},{default:a(()=>[...e[38]||(e[38]=[c("取消",-1)])]),_:1}),l(p,{type:"primary",onClick:Fe,loading:W.value},{default:a(()=>[...e[39]||(e[39]=[c("保存",-1)])]),_:1},8,["loading"])]),default:a(()=>[l(ce,{model:o,"label-width":"100px"},{default:a(()=>[l(Q,{label:"题型"},{default:a(()=>[l(me,{modelValue:o.exercise_type_name,"onUpdate:modelValue":e[11]||(e[11]=n=>o.exercise_type_name=n),style:{width:"100%"}},{default:a(()=>[l(h,{label:"单选题",value:"单选题"}),l(h,{label:"多选题",value:"多选题"}),l(h,{label:"填空题",value:"填空题"}),l(h,{label:"解答题",value:"解答题"}),l(h,{label:"判断题",value:"判断题"})]),_:1},8,["modelValue"])]),_:1}),l(Q,{label:"题干"},{default:a(()=>[l(O,{modelValue:o.stem,"onUpdate:modelValue":e[12]||(e[12]=n=>o.stem=n),type:"textarea",rows:3,placeholder:"请输入题干"},null,8,["modelValue"])]),_:1}),["单选题","多选题"].includes(o.exercise_type_name)?(r(),T(Q,{key:0,label:"选项"},{default:a(()=>[(r(!0),v(N,null,I(o.options,(n,q)=>(r(),v("div",{key:q,class:"option-item"},[s("span",$l,M(q)+".",1),l(O,{modelValue:o.options[q],"onUpdate:modelValue":u=>o.options[q]=u,placeholder:"选项内容",style:{width:"400px"}},null,8,["modelValue","onUpdate:modelValue"])]))),128)),s("div",Dl,[l(p,{type:"primary",link:"",onClick:$e},{default:a(()=>[...e[36]||(e[36]=[c("+ 添加选项",-1)])]),_:1}),l(p,{type:"danger",link:"",onClick:De},{default:a(()=>[...e[37]||(e[37]=[c("- 删除选项",-1)])]),_:1})])]),_:1})):x("",!0),l(Q,{label:"答案"},{default:a(()=>[l(O,{modelValue:o.answer,"onUpdate:modelValue":e[13]||(e[13]=n=>o.answer=n),placeholder:"请输入答案"},null,8,["modelValue"])]),_:1}),l(Q,{label:"解析"},{default:a(()=>[l(O,{modelValue:o.analysis,"onUpdate:modelValue":e[14]||(e[14]=n=>o.analysis=n),type:"textarea",rows:3,placeholder:"请输入解析"},null,8,["modelValue"])]),_:1}),l(Q,{label:"分值"},{default:a(()=>[l(pe,{modelValue:o.total_score,"onUpdate:modelValue":e[15]||(e[15]=n=>o.total_score=n),min:0,max:100},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),l(E,{modelValue:X.value,"onUpdate:modelValue":e[18]||(e[18]=n=>X.value=n),title:"题目详情",width:"800px"},{default:a(()=>[w.value?(r(),v("div",Fl,[s("div",Hl,[s("p",null,[e[40]||(e[40]=s("strong",null,"题型：",-1)),c(M(w.value.exercise_type_name),1)]),e[45]||(e[45]=s("p",null,[s("strong",null,"题干：")],-1)),s("div",{class:"question-content",innerHTML:w.value.stem},null,8,Ll),w.value.options&&w.value.options.length>0?(r(),v("p",Al,[...e[41]||(e[41]=[s("strong",null,"选项：",-1)])])):x("",!0),w.value.options&&w.value.options.length>0?(r(),v("div",Bl,[(r(!0),v(N,null,I(w.value.options,n=>(r(),v("div",{key:n.option_key,class:"option-line"},[s("strong",null,M(n.option_key)+".",1),e[42]||(e[42]=c()),s("span",{innerHTML:n.option_value},null,8,El)]))),128))])):x("",!0),s("p",null,[e[43]||(e[43]=s("strong",null,"答案：",-1)),s("span",{innerHTML:w.value.answer},null,8,Nl)]),w.value.analysis?(r(),v("p",Il,[...e[44]||(e[44]=[s("strong",null,"解析：",-1)])])):x("",!0),w.value.analysis?(r(),v("div",{key:3,class:"analysis-content",innerHTML:w.value.analysis},null,8,Kl)):x("",!0)])])):x("",!0)]),_:1},8,["modelValue"])])}}},Pl=Ge(Rl,[["__scopeId","data-v-30a9c32f"]]);export{Pl as default};
