import{_ as ie,K as ue,i as de,o as _,c as I,a as l,w as t,p,r as d,f as k,D as re,e as b,k as $,J as L,d as g,F as Q,y as W,n as ce,t as z,M as H,$ as pe,Q as me,m as D,z as j,C as ve,G as O,E as v,q as _e,a1 as fe}from"./index-1rGkZLYp.js";const be={class:"nav-manage"},ge={class:"section-header"},ye=["onClick"],Ve={class:"item-content"},Ce={class:"item-name"},we={class:"item-desc"},ke={key:0,class:"item-actions"},je={class:"section-header"},xe={class:"title"},Se={class:"name-cell"},Ne={__name:"NavManage",setup(Ue){const C=k([]),B=k([]),c=k(null),M=k(!1),S=k(!1),N=k(!1),s=k({id:null,name:"",subject_code:"",description:"",page_path:"",sort:0,icon:"books",text_icon:"",color:"#ffffff",is_public:!0}),n=k({id:null,name:"",page_path:"",sort:0,is_public:!1,subject_id:null});ue(()=>n.value,o=>{console.log("editingCategory 变化:",o)},{deep:!0});const R=_e(()=>{const o=C.value.find(e=>e.id===c.value);return o?o.name:"未选择"}),T=async()=>{try{const o=await p.getNavSubjects();C.value=o.data||[],C.value.length>0&&!c.value&&E(C.value[0].id)}catch(o){console.error("加载科目失败:",o)}},E=async o=>{c.value=o,q(o)},q=async o=>{M.value=!0;try{const e=await p.getNavCategories({subjectId:o});B.value=e.data||[]}catch(e){console.error("加载子项失败:",e)}finally{M.value=!1}},h=(o=null)=>{o?s.value={...o,is_public:o.is_public!==void 0?o.is_public:!0}:s.value={id:null,name:"",subject_code:"",description:"",page_path:"",sort:0,icon:"books",text_icon:"",color:"#ffffff",is_public:!0},S.value=!0},X=async()=>{if(!s.value.name){v.warning("请输入名称");return}if(!s.value.subject_code){v.warning("请输入科目代码");return}try{s.value.id?(await p.updateNavSubject(s.value.id,s.value),v.success("更新成功")):(await p.createNavSubject(s.value),v.success("创建成功")),S.value=!1,T()}catch(o){console.error("保存科目失败:",o)}},Y=o=>{O.confirm(`确定要删除科目 "${o.name}" 及其所有子项吗？`,"警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"error"}).then(async()=>{try{await p.deleteNavSubject(o.id),v.success("已删除"),c.value===o.id&&(c.value=null,B.value=[]),T()}catch(e){console.error("删除科目失败:",e)}})},A=(o=null)=>{if(o){const e=o.is_public===1||o.is_public===!0;console.log("打开编辑弹窗，原始数据:",o,"is_public:",e),n.value={...o,is_public:e,subject_id:o.subject_id||c.value}}else n.value={id:null,name:"",page_path:"",sort:0,is_public:!1,subject_id:c.value};N.value=!0},Z=async()=>{var o,e;if(!n.value.name){v.warning("请输入名称");return}try{const r=C.value.find(y=>y.id===c.value);if(!r){v.warning("请先选择科目");return}const i=n.value.is_public?1:0,u={...n.value,is_public:i};console.log("保存分类数据:",u),console.log("原始 source:",n.value.source);let x=null;try{const V=((await fe.getPublicCategories({level:1})).data||[]).find(U=>U.subject===r.subject_code);V&&(x=V.id)}catch(y){console.error("获取一级分类失败:",y)}if(n.value.id){const y=n.value.source==="public"||String(n.value.id).startsWith("public_"),f=i===1;if(console.log("originalIsPublic:",y,"newIsPublic:",f),y!==f)if(f)await p.deleteNavCategory(n.value.id),await p.createPublicCategory({name:u.name,level:2,subject:r.subject_code,parent_id:x||0,sort:u.sort||0,is_public:1}),v.success("已切换到公共题库");else{const V=String(n.value.id).replace("public_","");await p.deletePublicCategory(V),await p.createNavCategory({name:u.name,description:u.description||"",page_path:u.page_path||"",sort:u.sort||0,subject_id:c.value}),v.success("已切换到非公共题库")}else{if(f){const V=String(n.value.id).replace("public_",""),U={name:u.name,level:2,sort:u.sort||0,subject:r.subject_code,is_public:1,parentId:x||u.parentId||0};await p.updatePublicCategory(V,U)}else await p.updateNavCategory(n.value.id,u);v.success("更新成功")}}else i===1?await p.createPublicCategory({name:u.name,level:2,subject:r.subject_code,parent_id:x,sort:u.sort||0,is_public:1}):await p.createNavCategory({name:u.name,description:u.description||"",page_path:u.page_path||"",sort:u.sort||0,subject_id:c.value}),v.success("创建成功");N.value=!1,q(c.value)}catch(r){console.error("保存子项失败:",r),v.error("保存失败: "+(((e=(o=r.response)==null?void 0:o.data)==null?void 0:e.message)||r.message))}},ee=o=>{O.confirm(`确定要删除子项 "${o.name}" 吗？`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{var e,r;try{if(o.is_public){const i=String(o.id).replace("public_","");await p.deletePublicCategory(i)}else await p.deleteNavCategory(o.id);v.success("已删除"),q(c.value)}catch(i){console.error("删除子项失败:",i),v.error("删除失败: "+(((r=(e=i.response)==null?void 0:e.data)==null?void 0:r.message)||i.message))}})};return de(()=>{T()}),(o,e)=>{const r=d("el-icon"),i=d("el-button"),u=d("el-empty"),x=d("el-scrollbar"),y=d("el-aside"),f=d("el-table-column"),V=d("el-tag"),U=d("el-table"),le=d("el-main"),ae=d("el-container"),w=d("el-input"),m=d("el-form-item"),te=d("el-color-picker"),F=d("el-input-number"),G=d("el-switch"),J=d("el-form"),K=d("el-dialog"),oe=d("el-option"),se=d("el-select"),ne=re("loading");return _(),I("div",be,[l(ae,{class:"nav-container"},{default:t(()=>[l(y,{width:"300px",class:"subject-aside"},{default:t(()=>[b("div",ge,[e[21]||(e[21]=b("span",{class:"title"},"左侧科目",-1)),l(i,{type:"primary",size:"small",onClick:e[0]||(e[0]=a=>h())},{default:t(()=>[l(r,null,{default:t(()=>[l($(L))]),_:1}),e[20]||(e[20]=g("添加 ",-1))]),_:1})]),l(x,null,{default:t(()=>[(_(!0),I(Q,null,W(C.value,a=>(_(),I("div",{key:a.id,class:ce(["list-item",{active:c.value===a.id}]),onClick:P=>E(a.id)},[b("div",Ve,[b("div",Ce,z(a.name),1),b("div",we,z(a.page_path||"无路径"),1)]),c.value===a.id?(_(),I("div",ke,[l(i,{size:"small",circle:"",onClick:H(P=>h(a),["stop"])},{default:t(()=>[l(r,null,{default:t(()=>[l($(pe))]),_:1})]),_:1},8,["onClick"]),l(i,{size:"small",type:"danger",circle:"",onClick:H(P=>Y(a),["stop"])},{default:t(()=>[l(r,null,{default:t(()=>[l($(me))]),_:1})]),_:1},8,["onClick"])])):D("",!0)],10,ye))),128)),C.value.length===0?(_(),j(u,{key:0,description:"暂无科目","image-size":60})):D("",!0)]),_:1})]),_:1}),l(le,{class:"category-main"},{default:t(()=>[b("div",je,[b("span",xe,"右侧子项 ("+z(R.value)+")",1),l(i,{type:"primary",size:"small",disabled:!c.value,onClick:e[1]||(e[1]=a=>A())},{default:t(()=>[l(r,null,{default:t(()=>[l($(L))]),_:1}),e[22]||(e[22]=g("添加子项 ",-1))]),_:1},8,["disabled"])]),ve((_(),j(U,{data:B.value,border:"",stripe:"",style:{width:"100%"},class:"mt-20"},{default:t(()=>[l(f,{prop:"id",label:"ID",width:"80",align:"center"}),l(f,{prop:"name",label:"名称","min-width":"120"},{default:t(({row:a})=>[b("div",Se,[b("span",null,z(a.name),1),a.is_public?(_(),j(V,{key:0,size:"small",type:"warning",class:"ml-5"},{default:t(()=>[...e[23]||(e[23]=[g("公共题库",-1)])]),_:1})):(_(),j(V,{key:1,size:"small",type:"info",class:"ml-5"},{default:t(()=>[...e[24]||(e[24]=[g("非公共",-1)])]),_:1}))])]),_:1}),l(f,{prop:"page_path",label:"跳转路径","min-width":"200","show-overflow-tooltip":""}),l(f,{prop:"sort",label:"排序",width:"80",align:"center"}),l(f,{label:"操作",width:"150",align:"center",fixed:"right"},{default:t(({row:a})=>[l(i,{size:"small",onClick:P=>A(a)},{default:t(()=>[...e[25]||(e[25]=[g("编辑",-1)])]),_:1},8,["onClick"]),l(i,{size:"small",type:"danger",onClick:P=>ee(a)},{default:t(()=>[...e[26]||(e[26]=[g("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[ne,M.value]]),c.value?D("",!0):(_(),j(u,{key:0,description:"请先选择左侧科目"}))]),_:1})]),_:1}),l(K,{modelValue:S.value,"onUpdate:modelValue":e[12]||(e[12]=a=>S.value=a),title:s.value.id?"编辑科目":"添加科目",width:"500px"},{footer:t(()=>[l(i,{onClick:e[11]||(e[11]=a=>S.value=!1)},{default:t(()=>[...e[28]||(e[28]=[g("取消",-1)])]),_:1}),l(i,{type:"primary",onClick:X},{default:t(()=>[...e[29]||(e[29]=[g("保存",-1)])]),_:1})]),default:t(()=>[l(J,{model:s.value,"label-width":"100px"},{default:t(()=>[l(m,{label:"名称",required:""},{default:t(()=>[l(w,{modelValue:s.value.name,"onUpdate:modelValue":e[2]||(e[2]=a=>s.value.name=a),placeholder:"如：考研政治"},null,8,["modelValue"])]),_:1}),l(m,{label:"代码",required:""},{default:t(()=>[l(w,{modelValue:s.value.subject_code,"onUpdate:modelValue":e[3]||(e[3]=a=>s.value.subject_code=a),placeholder:"如：politics"},null,8,["modelValue"])]),_:1}),l(m,{label:"跳转路径"},{default:t(()=>[l(w,{modelValue:s.value.page_path,"onUpdate:modelValue":e[4]||(e[4]=a=>s.value.page_path=a),placeholder:"默认跳转路径"},null,8,["modelValue"])]),_:1}),l(m,{label:"描述"},{default:t(()=>[l(w,{modelValue:s.value.description,"onUpdate:modelValue":e[5]||(e[5]=a=>s.value.description=a),placeholder:"科目描述"},null,8,["modelValue"])]),_:1}),l(m,{label:"图标"},{default:t(()=>[l(w,{modelValue:s.value.icon,"onUpdate:modelValue":e[6]||(e[6]=a=>s.value.icon=a),placeholder:"icon名称"},null,8,["modelValue"])]),_:1}),l(m,{label:"文字图标"},{default:t(()=>[l(w,{modelValue:s.value.text_icon,"onUpdate:modelValue":e[7]||(e[7]=a=>s.value.text_icon=a),maxlength:"1",placeholder:"1个字"},null,8,["modelValue"])]),_:1}),l(m,{label:"背景颜色"},{default:t(()=>[l(te,{modelValue:s.value.color,"onUpdate:modelValue":e[8]||(e[8]=a=>s.value.color=a)},null,8,["modelValue"])]),_:1}),l(m,{label:"排序"},{default:t(()=>[l(F,{modelValue:s.value.sort,"onUpdate:modelValue":e[9]||(e[9]=a=>s.value.sort=a),min:0},null,8,["modelValue"])]),_:1}),l(m,{label:"公共题库"},{default:t(()=>[l(G,{modelValue:s.value.is_public,"onUpdate:modelValue":e[10]||(e[10]=a=>s.value.is_public=a),"active-text":"是","inactive-text":"否"},null,8,["modelValue"]),e[27]||(e[27]=b("div",{class:"field-hint"},"公共题库使用 public_categories 表管理分类",-1))]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),l(K,{modelValue:N.value,"onUpdate:modelValue":e[19]||(e[19]=a=>N.value=a),title:n.value.id?"编辑子项":"添加子项",width:"500px"},{footer:t(()=>[l(i,{onClick:e[18]||(e[18]=a=>N.value=!1)},{default:t(()=>[...e[31]||(e[31]=[g("取消",-1)])]),_:1}),l(i,{type:"primary",onClick:Z},{default:t(()=>[...e[32]||(e[32]=[g("保存",-1)])]),_:1})]),default:t(()=>[l(J,{model:n.value,"label-width":"100px"},{default:t(()=>[l(m,{label:"名称",required:""},{default:t(()=>[l(w,{modelValue:n.value.name,"onUpdate:modelValue":e[13]||(e[13]=a=>n.value.name=a),placeholder:"如：马原专题"},null,8,["modelValue"])]),_:1}),l(m,{label:"跳转路径"},{default:t(()=>[l(w,{modelValue:n.value.page_path,"onUpdate:modelValue":e[14]||(e[14]=a=>n.value.page_path=a),placeholder:"覆盖科目路径"},null,8,["modelValue"])]),_:1}),l(m,{label:"排序"},{default:t(()=>[l(F,{modelValue:n.value.sort,"onUpdate:modelValue":e[15]||(e[15]=a=>n.value.sort=a),min:0},null,8,["modelValue"])]),_:1}),l(m,{label:"所属科目"},{default:t(()=>[l(se,{modelValue:n.value.subject_id,"onUpdate:modelValue":e[16]||(e[16]=a=>n.value.subject_id=a),placeholder:"选择科目"},{default:t(()=>[(_(!0),I(Q,null,W(C.value,a=>(_(),j(oe,{key:a.id,label:a.name,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),n.value.id?(_(),j(m,{key:0,label:"公共库"},{default:t(()=>[l(G,{modelValue:n.value.is_public,"onUpdate:modelValue":e[17]||(e[17]=a=>n.value.is_public=a)},null,8,["modelValue"]),e[30]||(e[30]=b("span",{class:"ml-10 text-gray"},"慎重修改",-1))]),_:1})):D("",!0)]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}},Pe=ie(Ne,[["__scopeId","data-v-c1a3de05"]]);export{Pe as default};
