import{_ as se,i as ue,p as ne,a1 as A,o as c,c as m,e as f,a as u,w as s,z as C,m as R,f as d,r as p,F as V,y as j,d as E,t as G,E as O,q as oe,G as re}from"./index-1rGkZLYp.js";const ce={class:"public-import-container"},de={class:"file-uploader"},ie={key:0,class:"file-list"},ve={key:0,class:"file-name ml-10"},me={__name:"PublicImport",setup(fe){const g=d([{id:"politics",name:"政治"},{id:"math",name:"数学"},{id:"english",name:"英语"},{id:"computer",name:"计算机"}]),B=d(0),b=d([]),U=d(!1),h=d(null),y=d(""),_=d(null),$=d(!1),w=d(0),F=d([]),x=d(null),N=d([]),k=d(null),S=d([]),I=d(null);ue(()=>{H().then(()=>{M()})});const H=async()=>{try{const l=await ne.getNavSubjects();l.code===0&&l.data&&l.data.length>0&&(g.value=l.data.map(e=>({id:e.subject_code||e.name,name:e.name})))}catch(l){console.error("加载科目失败:",l)}},K=l=>{B.value=l},Q=l=>{const e=Array.from(l.target.files);if(e.length!==3){O.warning("请选择 3 个 JSON 文件");return}b.value=e},W=l=>{b.value.splice(l,1)},T=oe(()=>b.value.length===3),J=l=>new Promise(e=>{const t=new FileReader;t.onload=r=>e(JSON.parse(r.target.result)),t.readAsText(l)}),X=async()=>{var l;if(T.value){U.value=!0,h.value=null;try{let e,t,r;if(b.value.forEach(o=>{const L=o.name.toLowerCase();L.includes("questions")?t=o:L.includes("answers")?r=o:e=o}),!e||!t||!r)throw new Error("未能正确识别书籍、题目和答案文件");const n=await J(e),i=await J(t),v=await J(r),P=n.data||n,q=((l=i.data)==null?void 0:l.question_list)||i.data||i,D=v.data||v,a=await A.importPublicData({bookData:P,questions:Array.isArray(q)?q:[],answers:Array.isArray(D)?D:[],subject:g.value[B.value].id});if(a.code===0)h.value={success:!0,msg:"导入成功！书籍 ID: "+a.data.bookId},O.success("导入成功"),w.value=B.value,await M(),b.value=[];else throw new Error(a.msg)}catch(e){h.value={success:!1,msg:"导入失败: "+e.message},O.error(e.message)}finally{U.value=!1}}},M=async()=>{var e;const l=(e=g.value[w.value])==null?void 0:e.id;if(l)try{const t=await A.getPublicCategories({subject:l,level:2});t.code===0&&(F.value=t.data,x.value=null,N.value=[],k.value=null,S.value=[],I.value=null,y.value="")}catch(t){console.error("获取分类列表失败:",t)}},Y=()=>{M()},Z=async l=>{var r;x.value=l;const e=(r=g.value[w.value])==null?void 0:r.id,t=F.value[l];if(!(!e||!t))try{const n=await A.getPublicCategories({subject:e,parentId:t.id,level:3});n.code===0&&(N.value=n.data,k.value=null,S.value=[],I.value=null,y.value="",n.data.length===0&&z())}catch(n){console.error("获取子分类失败:",n)}},ee=l=>{k.value=l,z()},z=async()=>{var i;const l=(i=g.value[w.value])==null?void 0:i.id,e=F.value[x.value],t=N.value[k.value];if(!l||!e)return;const r=t?t.id:e.id,n=t?3:2;try{const v=await A.getPublicBooks({subject:l,categoryId:r,level:n});v.code===0&&(S.value=v.data,I.value=null,y.value="")}catch(v){console.error("获取书籍列表失败:",v)}},le=l=>{I.value=l;const e=S.value[l];e&&(y.value=e.id)},ae=l=>{const e=l.target.files[0];e&&(_.value=e)},te=async()=>{if(!(!y.value||!_.value)){$.value=!0;try{const l=await J(_.value),e=await A.structureBook({bookId:y.value,chapterData:l});if(e.code===0)O.success("结构化处理成功"),_.value=null;else throw new Error(e.msg)}catch(l){re.alert(l.message,"处理失败")}finally{$.value=!1}}};return(l,e)=>{const t=p("el-option"),r=p("el-select"),n=p("el-form-item"),i=p("el-button"),v=p("el-tag"),P=p("el-form"),q=p("el-card"),D=p("el-alert");return c(),m("div",ce,[e[13]||(e[13]=f("div",{class:"header"},[f("h2",null,"公共题库导入")],-1)),u(q,{class:"form-card"},{default:s(()=>[u(P,{"label-width":"120px"},{default:s(()=>[u(n,{label:"科目分类"},{default:s(()=>[u(r,{modelValue:B.value,"onUpdate:modelValue":e[0]||(e[0]=a=>B.value=a),placeholder:"请选择科目",onChange:K},{default:s(()=>[(c(!0),m(V,null,j(g.value,(a,o)=>(c(),C(t,{key:a.id,label:a.name,value:o},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),u(n,{label:"数据文件 (JSON)"},{default:s(()=>[f("div",de,[f("input",{type:"file",multiple:"",accept:".json",ref:"fileInput",style:{display:"none"},onChange:Q},null,544),u(i,{type:"primary",onClick:e[1]||(e[1]=a=>l.$refs.fileInput.click())},{default:s(()=>[...e[7]||(e[7]=[E("选择 3 个 JSON 文件",-1)])]),_:1}),b.value.length?(c(),m("div",ie,[(c(!0),m(V,null,j(b.value,(a,o)=>(c(),C(v,{key:o,class:"file-tag",closable:"",onClose:L=>W(o)},{default:s(()=>[E(G(a.name),1)]),_:2},1032,["onClose"]))),128))])):R("",!0),e[8]||(e[8]=f("div",{class:"tips"},"请确保文件名包含 'questions' 和 'answers' 以便自动识别。",-1))])]),_:1}),u(n,null,{default:s(()=>[u(i,{type:"primary",loading:U.value,disabled:!T.value,onClick:X},{default:s(()=>[...e[9]||(e[9]=[E(" 开始导入 ",-1)])]),_:1},8,["loading","disabled"])]),_:1})]),_:1})]),_:1}),h.value?(c(),C(D,{key:0,title:h.value.msg,type:h.value.success?"success":"error","show-icon":"",class:"result-alert"},null,8,["title","type"])):R("",!0),u(q,{class:"form-card structure-section"},{header:s(()=>[...e[10]||(e[10]=[f("div",{class:"clearfix"},[f("span",null,"章节结构化处理")],-1)])]),default:s(()=>[u(P,{"label-width":"120px"},{default:s(()=>[u(n,{label:"选择科目"},{default:s(()=>[u(r,{modelValue:w.value,"onUpdate:modelValue":e[2]||(e[2]=a=>w.value=a),placeholder:"请选择科目",onChange:Y},{default:s(()=>[(c(!0),m(V,null,j(g.value,(a,o)=>(c(),C(t,{key:a.id,label:a.name,value:o},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),u(n,{label:"选择大类"},{default:s(()=>[u(r,{modelValue:x.value,"onUpdate:modelValue":e[3]||(e[3]=a=>x.value=a),placeholder:"请选择分类",onChange:Z,disabled:!F.value.length},{default:s(()=>[(c(!0),m(V,null,j(F.value,(a,o)=>(c(),C(t,{key:a.id,label:a.name,value:o},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1}),u(n,{label:"选择小类"},{default:s(()=>[u(r,{modelValue:k.value,"onUpdate:modelValue":e[4]||(e[4]=a=>k.value=a),placeholder:"请选择小类",onChange:ee,disabled:!N.value.length},{default:s(()=>[(c(!0),m(V,null,j(N.value,(a,o)=>(c(),C(t,{key:a.id,label:a.name,value:o},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1}),u(n,{label:"选择书籍"},{default:s(()=>[u(r,{modelValue:I.value,"onUpdate:modelValue":e[5]||(e[5]=a=>I.value=a),placeholder:"请选择书籍",onChange:le,disabled:!S.value.length},{default:s(()=>[(c(!0),m(V,null,j(S.value,(a,o)=>(c(),C(t,{key:a.id,label:a.name||a.title,value:o},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1}),u(n,{label:"结构化文件"},{default:s(()=>[f("input",{type:"file",accept:".json",ref:"structureInput",style:{display:"none"},onChange:ae},null,544),u(i,{onClick:e[6]||(e[6]=a=>l.$refs.structureInput.click())},{default:s(()=>[...e[11]||(e[11]=[E("选择结构化 JSON 文件",-1)])]),_:1}),_.value?(c(),m("span",ve,G(_.value.name),1)):R("",!0)]),_:1}),u(n,null,{default:s(()=>[u(i,{type:"success",loading:$.value,disabled:!y.value||!_.value,onClick:te},{default:s(()=>[...e[12]||(e[12]=[E(" 生成章节结构 ",-1)])]),_:1},8,["loading","disabled"])]),_:1})]),_:1})]),_:1})])}}},ge=se(me,[["__scopeId","data-v-88151b32"]]);export{ge as default};
