import{_ as me,i as _e,o as _,c as k,a as l,w as s,p as T,f as d,r as n,u as ve,e as i,d as m,t as g,k as ge,V as be,m as fe,z as j,F as R,y as L,E as v,q as V}from"./index-1rGkZLYp.js";const ye={class:"question-import"},he={class:"header-actions"},ke={class:"upload-area mt-20"},we={key:0,class:"file-list-header mt-20"},Ve={class:"title"},xe={key:2,class:"empty-state mt-20"},Se={class:"structure-container"},Ce={class:"progress-content"},Fe={class:"current-file"},Ie={class:"stats mt-10"},Ne={__name:"QuestionImport",setup(Te){const P=ve(),q=d("batch"),x=d("med"),c=d([]),f=d(!1),w=d(0),J=d(0),U=d(""),u=d({subject:"public",category:"",bookId:"",file:null}),S=d([]),B=d([]),C=d(!1),F=V(()=>c.value.filter(e=>e.selected).length),M=V(()=>F.value),D=V(()=>c.value.length>0&&c.value.every(e=>e.selected||e.status==="success")),K=V(()=>{const e=c.value.filter(t=>t.selected).length;return e>0&&e<c.value.length}),W=()=>P.back(),G=e=>{if(!(e.raw.type==="application/json"||e.name.endsWith(".json"))){v.error("只能上传 JSON 文件");return}let o="unknown";const r=e.name.toLowerCase();r.includes("question")?o="questions":r.includes("answer")?o="answers":r.includes("book")?o="book":r.includes("struct")&&(o="structure"),c.value.push({raw:e.raw,filename:e.name,size:(e.size/1024).toFixed(2)+" KB",status:"pending",selected:!0,type:o,errorMsg:""})},H=e=>({questions:"primary",answers:"success",book:"warning",structure:"info",unknown:""})[e]||"",X=e=>({questions:"题目数据",answers:"答案数据",book:"书籍信息",structure:"章节结构",unknown:"未知"})[e]||"未知",Y=e=>({pending:"info",processing:"warning",success:"success",error:"danger"})[e]||"info",Z=(e,t)=>({pending:"等待导入",processing:"正在导入...",success:"导入成功",error:t||"导入失败"})[e]||"未知",ee=e=>{c.value.forEach(t=>{t.status!=="success"&&t.status!=="processing"&&(t.selected=e)})},te=e=>{c.value.splice(e,1)},O=async e=>{e.status="processing";try{const t=new FileReader,o=await new Promise((p,y)=>{t.onload=I=>p(JSON.parse(I.target.result)),t.onerror=y,t.readAsText(e.raw)}),r=await T.importQuestions(x.value,{type:e.type,data:o});r.code===0?(e.status="success",v.success(`${e.filename} 导入成功`)):(e.status="error",e.errorMsg=r.msg)}catch(t){e.status="error",e.errorMsg=t.message,v.error(`${e.filename} 导入失败: ${t.message}`)}},le=async()=>{const e=c.value.filter(t=>t.selected&&t.status!=="success");if(e.length!==0){f.value=!0,w.value=0;for(const t of e)U.value=t.filename,await O(t),w.value++,J.value=Math.round(w.value/M.value*100);f.value=!1,v.success("批量导入完成")}},ae=async()=>{u.value.category="",u.value.bookId="",await A()},A=async()=>{try{const e=await T.getCourses(u.value.subject);e.code===0&&(S.value=e.data||[])}catch(e){console.error("加载分类失败:",e)}},se=e=>{u.value.file=e.raw},oe=async()=>{if(!u.value.bookId||!u.value.file){v.warning("请选择书籍并上传结构化文件");return}C.value=!0;try{const e=new FileReader,t=await new Promise((r,p)=>{e.onload=y=>r(JSON.parse(y.target.result)),e.onerror=p,e.readAsText(u.value.file)}),o=await T.generateStructure({bookId:u.value.bookId,data:t});o.code===0?v.success("章节结构生成成功"):v.error(o.msg||"生成失败")}catch(e){v.error("处理失败: "+e.message)}finally{C.value=!1}};return _e(()=>{A()}),(e,t)=>{const o=n("el-option"),r=n("el-select"),p=n("el-button"),y=n("el-page-header"),I=n("el-icon"),$=n("el-upload"),z=n("el-checkbox"),b=n("el-table-column"),E=n("el-tag"),ne=n("el-table"),ue=n("el-empty"),Q=n("el-tab-pane"),h=n("el-form-item"),re=n("el-form"),ce=n("el-tabs"),de=n("el-progress"),ie=n("el-dialog");return _(),k("div",ye,[l(ce,{modelValue:q.value,"onUpdate:modelValue":t[4]||(t[4]=a=>q.value=a)},{default:s(()=>[l(Q,{label:"批量文件导入",name:"batch"},{default:s(()=>[l(y,{onBack:W,content:"试题数据导入"},{extra:s(()=>[i("div",he,[l(r,{modelValue:x.value,"onUpdate:modelValue":t[0]||(t[0]=a=>x.value=a),placeholder:"选择目标科目",class:"mr-10",style:{width:"150px"}},{default:s(()=>[l(o,{label:"西医综合",value:"med"}),l(o,{label:"数学",value:"math"}),l(o,{label:"政治",value:"politics"}),l(o,{label:"公共课",value:"public"}),l(o,{label:"计算机",value:"computer"})]),_:1},8,["modelValue"]),l(p,{type:"primary",loading:f.value,disabled:F.value===0,onClick:le},{default:s(()=>[m(" 确认批量导入 ("+g(F.value)+") ",1)]),_:1},8,["loading","disabled"])])]),_:1}),i("div",ke,[l($,{class:"upload-dragger",drag:"",action:"#",multiple:"","auto-upload":!1,"on-change":G,accept:".json"},{tip:s(()=>[...t[6]||(t[6]=[i("div",{class:"el-upload__tip"}," 支持导入书籍、题目、答案及结构化 JSON 文件 ",-1)])]),default:s(()=>[l(I,{class:"el-icon--upload"},{default:s(()=>[l(ge(be))]),_:1}),t[7]||(t[7]=i("div",{class:"el-upload__text"},[m(" 将 JSON 文件拖到此处，或 "),i("em",null,"点击上传")],-1))]),_:1})]),c.value.length>0?(_(),k("div",we,[i("div",Ve,"待处理文件 ("+g(c.value.length)+")",1),l(z,{"model-value":D.value,indeterminate:K.value,onChange:ee},{default:s(()=>[...t[8]||(t[8]=[m("全选",-1)])]),_:1},8,["model-value","indeterminate"])])):fe("",!0),c.value.length>0?(_(),j(ne,{key:1,data:c.value,border:"",stripe:"",class:"mt-10"},{default:s(()=>[l(b,{width:"50",align:"center"},{default:s(({row:a})=>[l(z,{modelValue:a.selected,"onUpdate:modelValue":N=>a.selected=N,disabled:a.status==="success"||a.status==="processing"},null,8,["modelValue","onUpdate:modelValue","disabled"])]),_:1}),l(b,{prop:"filename",label:"文件名","min-width":"200"}),l(b,{prop:"size",label:"大小",width:"120",align:"center"}),l(b,{label:"识别类型",width:"120",align:"center"},{default:s(({row:a})=>[l(E,{type:H(a.type)},{default:s(()=>[m(g(X(a.type)),1)]),_:2},1032,["type"])]),_:1}),l(b,{label:"状态",width:"150",align:"center"},{default:s(({row:a})=>[l(E,{type:Y(a.status)},{default:s(()=>[m(g(Z(a.status,a.errorMsg)),1)]),_:2},1032,["type"])]),_:1}),l(b,{label:"操作",width:"120",align:"center"},{default:s(({row:a,$index:N})=>[l(p,{link:"",type:"primary",disabled:a.status==="success"||a.status==="processing",onClick:pe=>O(a)},{default:s(()=>[...t[9]||(t[9]=[m(" 导入 ",-1)])]),_:1},8,["disabled","onClick"]),l(p,{link:"",type:"danger",onClick:pe=>te(N),disabled:a.status==="processing"},{default:s(()=>[...t[10]||(t[10]=[m(" 移除 ",-1)])]),_:1},8,["onClick","disabled"])]),_:1})]),_:1},8,["data"])):(_(),k("div",xe,[l(ue,{description:"暂无待导入文件，请点击上方区域上传"})]))]),_:1}),l(Q,{label:"章节结构化处理",name:"structure"},{default:s(()=>[i("div",Se,[l(re,{model:u.value,"label-width":"120px",style:{"max-width":"600px"},class:"mt-20"},{default:s(()=>[l(h,{label:"选择科目",required:""},{default:s(()=>[l(r,{modelValue:u.value.subject,"onUpdate:modelValue":t[1]||(t[1]=a=>u.value.subject=a),placeholder:"请选择科目",onChange:ae},{default:s(()=>[l(o,{label:"公共课",value:"public"}),l(o,{label:"西医综合",value:"med"})]),_:1},8,["modelValue"])]),_:1}),l(h,{label:"选择大类",required:""},{default:s(()=>[l(r,{modelValue:u.value.category,"onUpdate:modelValue":t[2]||(t[2]=a=>u.value.category=a),placeholder:"请选择分类",disabled:!S.value.length},{default:s(()=>[(_(!0),k(R,null,L(S.value,a=>(_(),j(o,{key:a.id,label:a.name,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1}),l(h,{label:"选择书籍",required:""},{default:s(()=>[l(r,{modelValue:u.value.bookId,"onUpdate:modelValue":t[3]||(t[3]=a=>u.value.bookId=a),placeholder:"请选择书籍",disabled:!B.value.length},{default:s(()=>[(_(!0),k(R,null,L(B.value,a=>(_(),j(o,{key:a._id,label:a.title,value:a._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1}),l(h,{label:"结构化文件",required:""},{default:s(()=>[l($,{class:"struct-upload",action:"#","auto-upload":!1,"on-change":se,limit:1,accept:".json"},{default:s(()=>[l(p,{type:"primary"},{default:s(()=>[...t[11]||(t[11]=[m("选择 JSON 文件",-1)])]),_:1})]),_:1})]),_:1}),l(h,null,{default:s(()=>[l(p,{type:"success",loading:C.value,onClick:oe},{default:s(()=>[...t[12]||(t[12]=[m("生成章节结构",-1)])]),_:1},8,["loading"])]),_:1})]),_:1},8,["model"])])]),_:1})]),_:1},8,["modelValue"]),l(ie,{modelValue:f.value,"onUpdate:modelValue":t[5]||(t[5]=a=>f.value=a),title:"正在导入数据",width:"400px","close-on-click-modal":!1,"close-on-press-escape":!1,"show-close":!1},{default:s(()=>[i("div",Ce,[i("div",Fe,g(U.value),1),l(de,{percentage:J.value,status:"success"},null,8,["percentage"]),i("div",Ie," 已完成: "+g(w.value)+" / "+g(M.value),1)])]),_:1},8,["modelValue"])])}}},qe=me(Ne,[["__scopeId","data-v-20383efb"]]);export{qe as default};
